<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸‰æ—¥æ±äº¬éŠ â€” æ—…éŠæ‰‹å¸³ & èˆªç­ä½å®¿å°å¹«æ‰‹</title>

  <!-- å¤–éƒ¨æ¨£å¼æª” -->
  <link rel="stylesheet" href="styles.css" />

  <!-- SortableJS for drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="app">
    <!-- App Header + Tabs -->
    <header class="app-header">
      <div class="app-title">
        <span>ğŸ§³</span> ä¸‰æ—¥æ±äº¬éŠå°å¹«æ‰‹
      </div>
      <nav class="app-nav">
        <button class="nav-tab active" data-page="timeline">ğŸ—’ï¸ è¡Œç¨‹</button>
        <button class="nav-tab" data-page="flights">âœˆï¸ èˆªç­</button>
        <button class="nav-tab" data-page="stays">ğŸ¨ ä½å®¿</button>
      </nav>
    </header>

    <!-- è¡Œç¨‹é ï¼ˆåŸæœ¬åŠŸèƒ½ï¼‰ -->
    <section id="page-timeline" class="page active">
      <div class="hero" role="banner">
        <div class="hero-left">
          <div class="trip-title">ä¸‰æ—¥æ±äº¬éŠ â€” æ‰‹å¸³è¡Œç¨‹</div>
          <div class="trip-sub">å¯æ–°å¢ / åˆªé™¤ / æ‹–æ›³æ’åº â€¢ è‡ªå‹•å„²å­˜åœ¨ç€è¦½å™¨</div>
          
          <div class="location-control">
            <label for="locationSelect">é¡¯ç¤ºå¤©æ°£åœ°é»ï¼š</label>
            <select id="locationSelect">
              <option value="tokyo">æ±äº¬</option>
              <option value="osaka">å¤§é˜ª</option>
              <option value="kyoto">äº¬éƒ½</option>
              <option value="taipei">å°åŒ—</option>
            </select>
          </div>
          
          <div class="controls">
            <button class="btn primary" id="addQuickBtn">ï¼‹ æ–°å¢ç©ºç™½æ´»å‹•</button>
            <button class="btn" id="openExport">åŒ¯å‡ºè¡Œç¨‹ JSON</button>
            <button class="btn ghost" id="resetBtn">é‡ç½®ç¯„ä¾‹è³‡æ–™</button>
          </div>
        </div>

        <div class="today-bubble" aria-hidden="true">
          <div class="date" id="todayText">--</div>
          <div class="temp" id="tempText">è¼‰å…¥æ°£æº«â€¦</div>
        </div>
      </div>

      <!-- editor short form -->
      <div class="editor" aria-label="æ–°å¢æ´»å‹•å€">
        <div class="field">
          <label>Day</label>
          <select id="daySelect">
            <option value="1">Day 1</option>
            <option value="2">Day 2</option>
            <option value="3">Day 3</option>
          </select>
        </div>

        <div class="field">
          <label>æ™‚é–“</label>
          <input id="timeInput" placeholder="09:00" />
        </div>

        <div class="field">
          <label>æ¨™é¡Œ</label>
          <input id="titleInput" placeholder="ä¾‹å¦‚ï¼šæ·ºè‰å¯º" />
        </div>

        <div class="field field--wide">
          <label>å‚™è¨» / åœ°é»é€£çµ (å¯é¸)</label>
          <input id="detailInput" placeholder="ç°¡çŸ­æè¿°" />
          <input id="mapInput" placeholder="Google Maps é€£çµï¼ˆå¯é¸ï¼‰" />
        </div>

        <div class="field field--button">
          <button class="btn primary btn-full" id="addBtn">æ–°å¢ / æ›´æ–°</button>
        </div>
      </div>

      <!-- days nav -->
      <div class="days" id="daysNav" aria-label="æ—¥ç¨‹åˆ‡æ›">
        <button class="day-btn active" data-day="1">Day 1 â€¢ æ±äº¬æ·ºè‰</button>
        <button class="day-btn" data-day="2">Day 2 â€¢ åŸå®¿ / æ¶‰è°·</button>
        <button class="day-btn" data-day="3">Day 3 â€¢ ç¯‰åœ° / éŠ€åº§</button>
      </div>

      <!-- timeline area -->
      <div class="timeline">
        <div class="drop-hint">åªè¦æ‹–æ›³å·¦å´çš„å°é»é»å³å¯é‡æ–°æ’åºï¼ˆé¿å…èª¤è§¸ï¼‰</div>
        <div id="timelineList" aria-live="polite"></div>
      </div>

      <div class="spacer"></div>
    </section>

    <!-- èˆªç­é  -->
    <section id="page-flights" class="page">
      <div class="section-card">
        <div class="section-header">
          <h2>âœˆï¸ æˆ‘çš„èˆªç­</h2>
          <p>å¾æ‰‹æ©Ÿæˆ–é›»è…¦é¸æ“‡ä¸€å€‹ <strong>flight.json</strong>ï¼Œåªåœ¨æœ¬æ©Ÿç€è¦½å™¨è®€å–ï¼Œä¸æœƒä¸Šå‚³åˆ° GitHub æˆ–é›²ç«¯ã€‚</p>
        </div>
        <div class="section-body">
          <input type="file" id="flightFileInput" accept="application/json" />
          <p class="section-hint">
            ç›®å‰æ”¯æ´ä½ æä¾›çš„æ ¼å¼ï¼š<code>{ "flights": [ { "departure": {...}, "arrival": {...} } ] }</code>
          </p>
        </div>
      </div>

      <section id="flightList"></section>
      <div class="spacer"></div>
    </section>

    <!-- ä½å®¿é  -->
    <section id="page-stays" class="page">
      <div class="section-card">
        <div class="section-header">
          <h2>ğŸ¨ æˆ‘çš„ä½å®¿</h2>
          <p>åŒæ¨£ä½¿ç”¨æœ¬æ©Ÿ JSON æª”ç®¡ç†ä½å®¿è³‡è¨Šï¼Œåªè¦é¸æª”æ¡ˆå³å¯ã€‚</p>
        </div>
        <div class="section-body">
          <input type="file" id="stayFileInput" accept="application/json" />
          <p class="section-hint">
            å»ºè­°æ ¼å¼ï¼ˆé™£åˆ—ï¼‰ï¼š<br />
            <code>[
  { "dateIn": "2026-04-05", "dateOut": "2026-04-08", "name": "æ–°å®¿é£¯åº—", "address": "æ±äº¬éƒ½æ–°å®¿å€ XX", "phone": "+81-3-1234-5678", "bookingId": "ABC123", "price": 12000, "notes": "å«æ—©é¤" }
]</code>
          </p>
        </div>
      </div>

      <section id="stayList"></section>
      <div class="spacer"></div>
    </section>
  </div>

  <!-- Modal: export -->
  <div class="modal-bg" id="modalBg">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="header">
        <h3 id="modalTitle">åŒ¯å‡º / è©³ç´°</h3>
        <div class="modal-actions">
          <button class="btn" id="copyBtn">è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
          <button class="btn ghost" id="closeModalBtn">é—œé–‰</button>
        </div>
      </div>
      <div id="modalBody">
        <textarea id="exportArea" readonly></textarea>
      </div>
    </div>
  </div>

<script>
/* =========================
   Tabs åˆ‡æ›
   ========================= */
const navTabs = document.querySelectorAll('.nav-tab');
const pages = document.querySelectorAll('.page');

navTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.dataset.page;
    navTabs.forEach(t => t.classList.toggle('active', t === tab));
    pages.forEach(p => p.classList.toggle('active', p.id === 'page-' + target));
  });
});

/* =========================
   è¡Œç¨‹ Data & Storage
   ========================= */
const STORAGE_KEY = "trip_timeline_schedule_v1";

function genId(){
  return "e_" + Math.random().toString(36).slice(2,9);
}

// sample three-day Tokyo itinerary
const SAMPLE = {
  meta: { title: "ä¸‰æ—¥æ±äº¬éŠ (ç¯„ä¾‹)", created: new Date().toISOString() },
  days: {
    1: [
      { id: genId(), time:"09:00", title:"æ¾å±± â†’ ç¾½ç”° (NH854)", detail:"ææ—©åˆ°æ©Ÿå ´è¾¦ç†è¨—é‹ã€‚", map:"https://maps.app.goo.gl/" },
      { id: genId(), time:"13:00", title:"é£¯åº— check-in", detail:"æ”¾è¡Œæç¨å¾®ä¼‘æ¯ã€‚", map:"" },
      { id: genId(), time:"15:00", title:"æ·ºè‰å¯º & ä»²è¦‹ä¸–å•†åº—è¡—", detail:"æ‹ç…§ã€é€›è¡—ã€åƒå°é»å¿ƒã€‚", map:"https://maps.app.goo.gl/" }
    ],
    2: [
      { id: genId(), time:"10:00", title:"æ˜æ²»ç¥å®®", detail:"æ£®æ—æ­¥é“æ•£æ­¥ã€‚", map:"https://maps.app.goo.gl/" },
      { id: genId(), time:"12:00", title:"åŸå®¿ç«¹ä¸‹é€š", detail:"é€›è¡—ã€å¯éº—é¤…ã€‚", map:"https://maps.app.goo.gl/" },
      { id: genId(), time:"16:00", title:"æ¶‰è°·åå­—è·¯å£", detail:"æ˜Ÿå·´å…‹çœ‹åå­—è·¯å£ã€‚", map:"https://maps.app.goo.gl/" }
    ],
    3: [
      { id: genId(), time:"09:30", title:"ç¯‰åœ°å ´å¤–å¸‚å ´", detail:"æµ·é®®ä¸¼æ—©é¤ã€‚", map:"https://maps.app.goo.gl/" },
      { id: genId(), time:"13:00", title:"éŠ€åº§é€›è¡—", detail:"UNIQLO / ç™¾è²¨ã€‚", map:"https://maps.app.goo.gl/" },
      { id: genId(), time:"18:00", title:"ç¾½ç”° â†’ æ¾å±± (NH851)", detail:"é ç•™é€šé—œæ™‚é–“ã€‚", map:"https://maps.app.goo.gl/" }
    ]
  }
};

function saveToStorage(obj){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  } catch(e){ console.error("save fail", e); }
}
function loadFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  } catch(e){ console.error("load fail", e); return null; }
}

/* =========================
   Boot / UI init
   ========================= */
let schedule = loadFromStorage() || SAMPLE;
let currentDay = 1;

const timelineList = document.getElementById("timelineList");
const daysNav = document.getElementById("daysNav");
const dayButtons = daysNav.querySelectorAll(".day-btn");

function setActiveDay(day){
  currentDay = day;
  dayButtons.forEach(b=>b.classList.toggle("active", b.dataset.day==String(day)));
  renderTimeline();
}
dayButtons.forEach(b=>{
  b.addEventListener("click", ()=> setActiveDay(Number(b.dataset.day)));
});

// render hero date
document.getElementById("todayText").textContent =
  new Date().toLocaleDateString("zh-TW", {year:"numeric", month:"short", day:"numeric"});

// å¤šåœ°é»å¤©æ°£è¨­å®š
const locationSelect = document.getElementById("locationSelect");
const tempTextEl = document.getElementById("tempText");

const CITY_COORDS = {
  tokyo:  { name: "æ±äº¬",  lat: 35.68,   lon: 139.69 },
  osaka:  { name: "å¤§é˜ª",  lat: 34.6937, lon: 135.5023 },
  kyoto:  { name: "äº¬éƒ½",  lat: 35.0116, lon: 135.7681 },
  taipei: { name: "å°åŒ—",  lat: 25.0478, lon: 121.5319 }
};

function updateWeather(cityKey){
  const city = CITY_COORDS[cityKey] || CITY_COORDS.tokyo;
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true`;

  tempTextEl.textContent = "è¼‰å…¥æ°£æº«â€¦";

  fetch(url)
    .then(r => r.json())
    .then(d => {
      if (d && d.current_weather) {
        const t = d.current_weather.temperature;
        tempTextEl.textContent = `${city.name} ${t}Â°C`;
      } else {
        tempTextEl.textContent = `${city.name} æ°£æº«ç„¡æ³•å–å¾—`;
      }
    })
    .catch(() => {
      tempTextEl.textContent = `${city.name} æ°£æº«è¼‰å…¥å¤±æ•—`;
    });
}

// ä¸‹æ‹‰é¸å–®åˆ‡æ›æ™‚æ›´æ–°
if (locationSelect) {
  locationSelect.addEventListener("change", (e) => {
    updateWeather(e.target.value);
  });

  // é é¢è¼‰å…¥æ™‚å…ˆä¾é è¨­å€¼è¼‰ä¸€æ¬¡
  updateWeather(locationSelect.value);
}


/* =========================
   Render timeline
   ========================= */
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"','&quot;'); }

function renderTimeline(){
  const list = schedule.days?.[currentDay] || [];
  timelineList.innerHTML = "";
  if(!list.length){
    timelineList.innerHTML = `<div class="empty-hint">å°šç„¡æ´»å‹•ï¼Œè«‹ç”¨ä¸Šæ–¹è¡¨å–®æ–°å¢æˆ–é»ã€Œæ–°å¢ç©ºç™½æ´»å‹•ã€</div>`;
    return initSortable();
  }

  list.forEach((ev) => {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.id = ev.id;
    card.innerHTML = `
      <div class="card-handle" aria-hidden="true"></div>
      <div class="icon" aria-hidden="true">ğŸ“</div>
      <div class="body">
        <div class="title-row">
          <div class="title">${escapeHtml(ev.title || "ï¼ˆæœªå¡«ï¼‰")}</div>
          ${ev.time ? `<div class="time-pill">${escapeHtml(ev.time)}</div>` : ""}
        </div>
        <div class="meta">${escapeHtml(ev.detail || "")}</div>
        <div class="actions">
          ${ev.map ? `<a href="${ev.map}" target="_blank" class="link-btn">é–‹åœ°åœ–</a>` : ""}
          <button class="link-btn" data-action="edit">ç·¨è¼¯</button>
          <button class="link-btn danger" data-action="delete">åˆªé™¤</button>
        </div>
      </div>
    `;
    timelineList.appendChild(card);
  });

  initCardButtons();
  initSortable();
}

/* =========================
   Sortable (drag & drop)
   ========================= */
let sortableInstance = null;
function initSortable(){
  if(sortableInstance) {
    try{ sortableInstance.destroy(); }catch(e){}
    sortableInstance = null;
  }

  sortableInstance = new Sortable(timelineList, {
    animation: 160,
    ghostClass: 'ghost',
    fallbackOnBody: true,
    swapThreshold: 0.65,
    handle: '.card-handle',   // åªå…è¨±æ‹–æ›³æ¡æŠŠ
    onEnd: function(){
      const ids = Array.from(timelineList.children).map(c => c.dataset.id);
      const dayArr = schedule.days[currentDay] || [];
      const newArr = ids.map(id => dayArr.find(x=>x.id===id)).filter(Boolean);
      schedule.days[currentDay] = newArr;
      saveToStorage(schedule);
      renderTimeline();
    }
  });
}

/* =========================
   Card action buttons (edit/delete)
   ========================= */
function initCardButtons(){
  timelineList.querySelectorAll("[data-action]").forEach(btn=>{
    btn.onclick = function(){
      const action = this.dataset.action;
      const card = this.closest(".card");
      const id = card?.dataset.id;
      if(!id) return;
      if(action === "delete"){
        const arr = schedule.days[currentDay];
        schedule.days[currentDay] = arr.filter(x=>x.id !== id);
        saveToStorage(schedule);
        renderTimeline();
      } else if(action === "edit"){
        const ev = schedule.days[currentDay].find(x=>x.id===id);
        if(!ev) return;
        document.getElementById("daySelect").value = String(currentDay);
        document.getElementById("timeInput").value = ev.time || "";
        document.getElementById("titleInput").value = ev.title || "";
        document.getElementById("detailInput").value = ev.detail || "";
        document.getElementById("mapInput").value = ev.map || "";
        document.getElementById("addBtn").dataset.editId = id;
        scrollToTop();
      }
    };
  });
}

/* =========================
   Add / Quick add / Reset
   ========================= */
document.getElementById("addBtn").addEventListener("click", function(){
  const day = Number(document.getElementById("daySelect").value);
  const time = document.getElementById("timeInput").value.trim();
  const title = document.getElementById("titleInput").value.trim() || "ï¼ˆç„¡æ¨™é¡Œï¼‰";
  const detail = document.getElementById("detailInput").value.trim();
  const map = document.getElementById("mapInput").value.trim();

  const editId = this.dataset.editId;
  if(editId){
    const arr = schedule.days[day] || [];
    const idx = arr.findIndex(x=>x.id===editId);
    if(idx>=0){
      arr[idx] = { ...arr[idx], time, title, detail, map };
    }
    delete this.dataset.editId;
  } else {
    const ev = { id: genId(), time, title, detail, map };
    schedule.days[day] = schedule.days[day] || [];
    schedule.days[day].push(ev);
  }
  document.getElementById("timeInput").value = "";
  document.getElementById("titleInput").value = "";
  document.getElementById("detailInput").value = "";
  document.getElementById("mapInput").value = "";
  saveToStorage(schedule);
  setActiveDay(day);
});

document.getElementById("addQuickBtn").addEventListener("click", ()=>{
  const ev = { id: genId(), time:"09:00", title:"æ–°æ´»å‹•", detail:"å¯ç·¨è¼¯å…§å®¹", map:"" };
  schedule.days[currentDay] = schedule.days[currentDay] || [];
  schedule.days[currentDay].push(ev);
  saveToStorage(schedule);
  renderTimeline();
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(confirm("ç¢ºå®šè¦é‡ç½®ç‚ºä¸‰æ—¥ç¯„ä¾‹è³‡æ–™å—ï¼Ÿç›®å‰å…§å®¹æœƒè¢«è¦†è“‹ã€‚")) {
    schedule = JSON.parse(JSON.stringify(SAMPLE));
    saveToStorage(schedule);
    setActiveDay(1);
  }
});

/* =========================
   Export / Modal
   ========================= */
const modalBg = document.getElementById("modalBg");
const exportArea = document.getElementById("exportArea");
document.getElementById("openExport").addEventListener("click", ()=>{
  const payload = JSON.stringify(schedule, null, 2);
  exportArea.value = payload;
  document.getElementById("modalTitle").textContent = "åŒ¯å‡ºè¡Œç¨‹ JSONï¼ˆå¯è¤‡è£½ï¼‰";
  modalBg.style.display = "flex";
});
document.getElementById("copyBtn").addEventListener("click", ()=>{
  const text = exportArea.value;
  navigator.clipboard?.writeText(text).then(()=>{
    alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
  }).catch(()=>{ alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚"); });
});
document.getElementById("closeModalBtn").addEventListener("click", closeModal);
modalBg.addEventListener("click", (e)=>{ if(e.target===modalBg) closeModal(); });
function closeModal(){ modalBg.style.display = "none"; }

/* =========================
   Flights (ä½ çš„ JSON æ ¼å¼)
   ========================= */
const flightFileInput = document.getElementById('flightFileInput');
const flightList = document.getElementById('flightList');

// æŠŠ "05APR2026" è½‰æˆ "2026-04-05"
function formatGdsDate(str){
  if (!str || str.length < 7) return str || '';
  const day = str.slice(0, 2);
  const mon = str.slice(2, 5).toUpperCase();
  const year = str.slice(5);
  const map = {
    JAN:'01', FEB:'02', MAR:'03', APR:'04',
    MAY:'05', JUN:'06', JUL:'07', AUG:'08',
    SEP:'09', OCT:'10', NOV:'11', DEC:'12'
  };
  const mm = map[mon] || mon;
  return `${year}-${mm}-${day}`;
}

// æŠŠ "1650" è½‰æˆ "16:50"
function formatGdsTime(str){
  if (!str) return '';
  const s = String(str);
  if (s.length < 4) return s;
  return s.slice(0, 2) + ':' + s.slice(2, 4);
}

// å°ˆé–€é‡å°ä½ æä¾›çš„ { flights: [ { departure:{...}, arrival:{...} } ] } è§£æ
function normalizeFlightsFromYourJson(raw){
  if (!raw || !Array.isArray(raw.flights)) {
    alert("é€™å€‹ flight.json è£¡é¢æ²’æœ‰ flights é™£åˆ—ï¼Œè«‹ç¢ºèªæª”æ¡ˆå…§å®¹ã€‚");
    console.error("Unexpected flight JSON:", raw);
    return [];
  }

  return raw.flights.map(f => {
    const dep = f.departure || {};
    const arr = f.arrival || {};

    const date = dep.date || arr.date || '';
    const fromCity = dep.city || '';
    const toCity = arr.city || '';

    const departTime = formatGdsTime(dep.time);
    const arriveTime = formatGdsTime(arr.time);

    const airline = arr.operatingCarrier || '';
    const flightNumber = dep.flightNo || '';

    const notesParts = [];
    if (dep.class) notesParts.push(`è‰™ç­‰ ${dep.class}`);
    if (dep.baggage) notesParts.push(`è¡Œæ ${dep.baggage}`);
    if (arr.seat) notesParts.push(`åº§ä½ ${arr.seat}`);
    if (dep.terminal) notesParts.push(`å‡ºç™¼èˆªå»ˆ ${dep.terminal}`);
    if (arr.terminal) notesParts.push(`æŠµé”èˆªå»ˆ ${arr.terminal}`);
    const notes = notesParts.join("ï½œ");

    return {
      date: formatGdsDate(date),
      from: fromCity,
      to: toCity,
      flightNumber,
      departTime,
      arriveTime,
      airline,
      notes
    };
  });
}

if (flightFileInput){
  flightFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const raw = JSON.parse(e.target.result);
        const flights = normalizeFlightsFromYourJson(raw);
        renderFlights(flights);
      } catch (err) {
        alert('è®€å–æˆ–è§£æ JSON å¤±æ•—ï¼Œè«‹ç¢ºèª flight.json æ ¼å¼æ­£ç¢ºã€‚');
        console.error(err);
      }
    };
    reader.readAsText(file, 'utf-8');
  });
}

function renderFlights(flights){
  flightList.innerHTML = '';
  if (!Array.isArray(flights) || flights.length === 0){
    flightList.innerHTML = '<div class="card"><div class="body">ç›®å‰æ²’æœ‰èˆªç­è³‡æ–™ã€‚</div></div>';
    return;
  }
  flights.forEach(f => {
    const card = document.createElement('div');
    card.className = 'card card--list';
    card.innerHTML = `
      <div class="card-handle fake-handle"></div>
      <div class="icon">âœˆï¸</div>
      <div class="body">
        <div class="title-row">
          <div class="title">
            ${escapeHtml(f.from || '')} â†’ ${escapeHtml(f.to || '')}
          </div>
          ${f.date ? `<div class="time-pill">${escapeHtml(f.date)}</div>` : ""}
        </div>
        <div class="meta">
          èˆªç­ï¼š<strong>${escapeHtml(f.flightNumber || '-')}</strong>
          ${f.airline ? ` â€¢ èˆªç©ºå…¬å¸ï¼š${escapeHtml(f.airline)}` : ''}
        </div>
        <div class="meta">
          èµ·é£›ï¼š${escapeHtml(f.departTime || '-')}ã€€æŠµé”ï¼š${escapeHtml(f.arriveTime || '-')}
        </div>
        <div class="meta meta--small">
          å‚™è¨»ï¼š${escapeHtml(f.notes || 'â€”')}
        </div>
      </div>
    `;
    flightList.appendChild(card);
  });
}

/* =========================
   Stays (local JSON only)
   ========================= */
const stayFileInput = document.getElementById('stayFileInput');
const stayList = document.getElementById('stayList');

if (stayFileInput){
  stayFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const stays = JSON.parse(e.target.result);
        renderStays(stays);
      } catch (err) {
        alert('è®€å–æˆ–è§£æ JSON å¤±æ•—ï¼Œè«‹ç¢ºèªä½å®¿æª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
        console.error(err);
      }
    };
    reader.readAsText(file, 'utf-8');
  });
}

function renderStays(stays){
  stayList.innerHTML = '';
  if (!Array.isArray(stays) || stays.length === 0){
    stayList.innerHTML = '<div class="card"><div class="body">ç›®å‰æ²’æœ‰ä½å®¿è³‡æ–™ã€‚</div></div>';
    return;
  }
  stays.forEach(s => {
    const card = document.createElement('div');
    card.className = 'card card--list';
    card.innerHTML = `
      <div class="card-handle fake-handle"></div>
      <div class="icon">ğŸ¨</div>
      <div class="body">
        <div class="title-row">
          <div class="title">${escapeHtml(s.name || 'æœªå‘½åä½å®¿')}</div>
          <div class="time-pill">
            ${escapeHtml(s.dateIn || '-')} ~ ${escapeHtml(s.dateOut || '-')}
          </div>
        </div>
        <div class="meta">åœ°å€ï¼š${escapeHtml(s.address || '-')}</div>
        <div class="meta">é›»è©±ï¼š${escapeHtml(s.phone || '-')}</div>
        <div class="meta">è¨‚å–®ç·¨è™Ÿï¼š<strong>${escapeHtml(s.bookingId || '-')}</strong></div>
        <div class="meta">
          åƒ¹æ ¼ï¼š${s.price != null ? escapeHtml(String(s.price)) + ' å…ƒ' : '-'}
        </div>
        <div class="meta meta--small">
          å‚™è¨»ï¼š${escapeHtml(s.notes || 'â€”')}
        </div>
      </div>
    `;
    stayList.appendChild(card);
  });
}

/* =========================
   Utility
   ========================= */
function scrollToTop(){
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* initial load */
setActiveDay(1);
renderTimeline();
window.addEventListener("beforeunload", ()=> saveToStorage(schedule));
</script>
</body>
</html>
