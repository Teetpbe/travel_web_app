<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¸‰æ—¥æ±äº¬éŠ â€” æ—…éŠæ‰‹å¸³ & èˆªç­ä½å®¿å°å¹«æ‰‹1.0</title>

<!-- SortableJS for drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
  :root{
    /* å¿«æ¨‚æ—…éŠè‰²ç³» */
    --bg:#ffe8d6;           /* æ©˜ç²‰åº• */
    --bg2:#fdfdfd;
    --card:#fffdf8;
    --accent:#ff7b54;       /* æ©˜è‰²ä¸»è‰² */
    --accent-soft:#ffe2cf;
    --muted:#6b6b6b;
    --shadow: 0 8px 22px rgba(0,0,0,0.06);
    --radius:16px;
  }
  html,body{height:100%;}
  body{
    margin:0;
    font-family: -apple-system, "BlinkMacSystemFont","Noto Sans TC","Helvetica Neue", Arial;
    background: radial-gradient(circle at top, #ffe8d6 0%, #fffaf3 40%, #f4f8ff 100%);
    color:#1a1a1a;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding-bottom:88px; /* for bottom space */
  }

  .app {
    max-width:900px;
    margin:18px auto;
    padding:18px;
  }

  /* App Header + Tabs */
  .app-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
    gap:12px;
  }
  .app-title{
    font-size:20px;
    font-weight:800;
    color:var(--accent);
    display:flex;
    align-items:center;
    gap:6px;
  }
  .app-title span{
    font-size:22px;
  }

  .app-nav{
    display:flex;
    gap:6px;
    background:rgba(255,255,255,0.8);
    padding:4px;
    border-radius:999px;
    box-shadow:var(--shadow);
  }
  .nav-tab{
    border:none;
    background:transparent;
    padding:6px 12px;
    border-radius:999px;
    font-size:13px;
    cursor:pointer;
    color:var(--muted);
    font-weight:600;
    white-space:nowrap;
  }
  .nav-tab.active{
    background:linear-gradient(135deg,#ffb198,#ff7b54);
    color:#fff;
  }

  .page{
    display:none;
  }
  .page.active{
    display:block;
  }

  /* Hero (for timeline page) */
  .hero {
    background: linear-gradient(115deg, rgba(255,255,255,0.96), rgba(173,216,255,0.25));
    border-radius: var(--radius);
    padding:16px;
    display:flex;
    gap:12px;
    align-items:center;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.9);
  }
  .hero-left { flex:1; }
  .trip-title { font-size:18px; font-weight:700; color: var(--accent); }
  .trip-sub { font-size:13px; color:var(--muted); margin-top:4px; }
  .today-bubble {
    min-width:92px;
    text-align:center;
    background:linear-gradient(180deg, #fff, #fbf8f5);
    border-radius:14px;
    padding:10px;
    box-shadow: 0 10px 22px rgba(0,0,0,0.08);
    border:1px solid rgba(255,255,255,0.9);
  }
  .today-bubble .date { font-weight:700; font-size:14px; color:var(--accent); }
  .today-bubble .temp { font-size:12px; color:var(--muted); margin-top:4px; }

  /* Controls */
  .controls {
    display:flex;
    gap:8px;
    margin-top:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  .btn {
    background:var(--card);
    border:1px solid rgba(0,0,0,0.04);
    padding:8px 12px;
    border-radius:999px;
    box-shadow: var(--shadow);
    cursor:pointer;
    font-weight:600;
    font-size:13px;
  }
  .btn.primary {
    background: linear-gradient(135deg,#ffb198,#ff7b54);
    color:white;
    border: none;
  }
  .btn.ghost {
    background:transparent;
    border:1px dashed rgba(0,0,0,0.08);
  }

  /* Editor area */
  .editor {
    margin-top:16px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
  }
  .field {
    background:var(--card);
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.03);
    box-shadow: var(--shadow);
  }
  .field label{
    font-weight:700;
    font-size:13px;
    display:block;
    margin-bottom:6px;
  }
  .field input, .field select, .field textarea {
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.06);
    padding:8px;
    font-size:14px;
    width:220px;
    outline:none;
    background:#fffdfc;
  }
  .field textarea { width:100%; min-height:54px; resize:vertical; }

  /* Days nav */
  .days {
    display:flex;
    gap:8px;
    margin-top:18px;
    overflow:auto;
    padding-bottom:6px;
  }
  .day-btn {
    padding:8px 12px;
    border-radius:999px;
    background:rgba(255,255,255,0.8);
    border:1px solid rgba(0,0,0,0.04);
    cursor:pointer;
    min-width:110px;
    text-align:center;
    font-size:13px;
  }
  .day-btn.active {
    background:linear-gradient(135deg,#fff,#ffe2cf);
    border: 1px solid rgba(255,123,84,0.35);
    box-shadow: var(--shadow);
    color:var(--accent);
    font-weight:700;
  }

  /* Timeline container */
  .timeline {
    margin-top:16px;
  }
  .timeline .drop-hint {
    color:var(--muted);
    font-size:13px;
    margin-bottom:6px;
  }

  /* Card */
  .card {
    background: var(--card);
    border-radius: 16px;
    padding:12px;
    margin-bottom:12px;
    box-shadow: var(--shadow);
    border:1px solid rgba(255,255,255,0.9);
    display:flex;
    gap:10px;
    align-items:flex-start;
    touch-action: pan-y;
  }
  .card .time {
    width:72px;
    font-weight:700;
    color:var(--accent);
    font-size:14px;
  }
  .card .body { flex:1; }
  .card .title { font-weight:700; font-size:15px; margin-bottom:4px; }
  .card .meta { color:var(--muted); font-size:13px; margin-bottom:8px; }
  .card .actions { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
  .icon {
    width:40px;height:40px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    background: linear-gradient(180deg,#fff,#f7f3ef);
    border:1px solid rgba(255,255,255,0.9);
    font-size:18px;
  }

  .card-title{
    font-weight:700;
    font-size:15px;
    margin-bottom:4px;
  }
  .chip{
    display:inline-block;
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    background:var(--accent-soft);
    color:var(--accent);
    margin-right:6px;
    margin-top:3px;
  }

  /* Small text buttons */
  .link-btn {
    background:rgba(255,255,255,0.9);
    border:none;
    color:var(--accent);
    font-weight:700;
    cursor:pointer;
    font-size:12px;
    padding:6px 8px;
    border-radius:999px;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
  }

  .spacer { height:80px; }

  /* Modal for details + export */
  .modal-bg {
    position:fixed; left:0; top:0; width:100%; height:100%;
    background: rgba(0,0,0,0.35);
    display:none; align-items:center; justify-content:center;
    z-index:90;
  }
  .modal {
    width:92%;
    max-width:760px;
    background:white;
    padding:16px;
    border-radius:16px;
    box-shadow: 0 20px 60px rgba(10,10,10,0.35);
  }
  .modal .header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .modal textarea {
    width:100%;
    min-height:260px;
    margin-top:12px;
    padding:12px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,0.06);
    font-family: monospace;
    font-size:13px;
    background:#fffdf8;
  }

  /* Flights / Stays helper text */
  .section-intro{
    margin:10px 0 12px;
    font-size:13px;
    color:var(--muted);
  }

  @media (max-width:520px){
    .app{
      padding:12px;
    }
    .field input, .field select { width:150px; }
    .card { padding:10px; }
    .card .time { width:64px; font-size:13px; }
    .app-header{
      flex-direction:column;
      align-items:flex-start;
    }
  }
</style>
</head>
<body>
  <div class="app">
    <!-- App Header + Tabs -->
    <header class="app-header">
      <div class="app-title">
        <span>ğŸ§³</span> ä¸‰æ—¥æ±äº¬éŠå°å¹«æ‰‹
      </div>
      <nav class="app-nav">
        <button class="nav-tab active" data-page="timeline">ğŸ—’ï¸ è¡Œç¨‹</button>
        <button class="nav-tab" data-page="flights">âœˆï¸ èˆªç­</button>
        <button class="nav-tab" data-page="stays">ğŸ¨ ä½å®¿</button>
      </nav>
    </header>

    <!-- è¡Œç¨‹é ï¼ˆåŸæœ¬å…§å®¹ï¼‰ -->
    <section id="page-timeline" class="page active">
      <div class="hero" role="banner">
        <div class="hero-left">
          <div class="trip-title">ä¸‰æ—¥æ±äº¬éŠ â€” æ‰‹å¸³è¡Œç¨‹</div>
          <div class="trip-sub">å¯æ–°å¢ / åˆªé™¤ / æ‹–æ›³æ’åº â€¢ è‡ªå‹•å„²å­˜åœ¨ç€è¦½å™¨</div>

          <div class="controls">
            <button class="btn primary" id="addQuickBtn">ï¼‹ æ–°å¢ç©ºç™½æ´»å‹•</button>
            <button class="btn" id="openExport">åŒ¯å‡ºè¡Œç¨‹ JSON</button>
            <button class="btn ghost" id="resetBtn">é‡ç½®ç¯„ä¾‹è³‡æ–™</button>
          </div>
        </div>

        <div class="today-bubble" aria-hidden="true">
          <div class="date" id="todayText">--</div>
          <div class="temp" id="tempText">è¼‰å…¥æ°£æº«â€¦</div>
        </div>
      </div>

      <!-- editor short form -->
      <div class="editor" aria-label="æ–°å¢æ´»å‹•å€">
        <div class="field">
          <label>Day</label>
          <select id="daySelect">
            <option value="1">Day 1</option>
            <option value="2">Day 2</option>
            <option value="3">Day 3</option>
          </select>
        </div>

        <div class="field">
          <label>æ™‚é–“</label>
          <input id="timeInput" placeholder="09:00" />
        </div>

        <div class="field">
          <label>æ¨™é¡Œ</label>
          <input id="titleInput" placeholder="ä¾‹å¦‚ï¼šæ·ºè‰å¯º" />
        </div>

        <div class="field" style="flex:1; min-width:180px;">
          <label>å‚™è¨» / åœ°é»é€£çµ (å¯é¸)</label>
          <input id="detailInput" placeholder="ç°¡çŸ­æè¿°" />
          <input id="mapInput" placeholder="Google Maps é€£çµï¼ˆå¯é¸ï¼‰" style="margin-top:8px;" />
        </div>

        <div style="display:flex; align-items:flex-end;">
          <button class="btn primary" id="addBtn">æ–°å¢ / æ›´æ–°</button>
        </div>
      </div>

      <!-- days nav -->
      <div class="days" id="daysNav" aria-label="æ—¥ç¨‹åˆ‡æ›">
        <button class="day-btn active" data-day="1">Day 1 â€¢ æ±äº¬æ·ºè‰</button>
        <button class="day-btn" data-day="2">Day 2 â€¢ åŸå®¿ / æ¶‰è°·</button>
        <button class="day-btn" data-day="3">Day 3 â€¢ ç¯‰åœ° / éŠ€åº§</button>
      </div>

      <!-- timeline area -->
      <div class="timeline">
        <div class="drop-hint">æŒ‰ä½æ•´å¼µå¡ç‰‡å³å¯æ‹–æ›³é‡æ–°æ’åºï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰</div>
        <div id="timelineList" aria-live="polite"></div>
      </div>

      <div class="spacer"></div>
    </section>

    <!-- èˆªç­é  -->
    <section id="page-flights" class="page">
      <div class="card">
        <div class="body">
          <div class="card-title">âœˆï¸ æˆ‘çš„èˆªç­</div>
          <p class="section-intro">
            å¾æ‰‹æ©Ÿæˆ–é›»è…¦é¸æ“‡ä¸€å€‹ <strong>JSON æª”</strong>ï¼Œå…§å®¹åªæœƒåœ¨æœ¬æ©Ÿç€è¦½å™¨è®€å–ï¼Œ
            <strong>ä¸æœƒä¸Šå‚³åˆ° GitHub æˆ–ä»»ä½•ä¼ºæœå™¨</strong>ã€‚
          </p>
          <input type="file" id="flightFileInput" accept="application/json" />
          <p class="section-intro">
            å»ºè­°æ ¼å¼ï¼ˆé™£åˆ—ï¼‰ï¼š<br>
            <code>[
              { "date": "2025-12-20", "from": "TPE", "to": "NRT", "flightNumber": "JL802", "departTime": "10:30", "arriveTime": "14:30", "airline": "JAL", "notes": "é çª—åº§ä½" }
            ]</code>
          </p>
        </div>
      </div>

      <section id="flightList"></section>
      <div class="spacer"></div>
    </section>

    <!-- ä½å®¿é  -->
    <section id="page-stays" class="page">
      <div class="card">
        <div class="body">
          <div class="card-title">ğŸ¨ æˆ‘çš„ä½å®¿</div>
          <p class="section-intro">
            åŒæ¨£ä½¿ç”¨æœ¬æ©Ÿ JSON æª”ç®¡ç†ä½å®¿è³‡è¨Šï¼Œåªè¦é»é¸ä¸‹é¢çš„æŒ‰éˆ•é¸æª”æ¡ˆå³å¯ã€‚
          </p>
          <input type="file" id="stayFileInput" accept="application/json" />
          <p class="section-intro">
            å»ºè­°æ ¼å¼ï¼ˆé™£åˆ—ï¼‰ï¼š<br>
            <code>[
              { "dateIn": "2025-12-20", "dateOut": "2025-12-23", "name": "æ–°å®¿é£¯åº—", "address": "æ±äº¬éƒ½æ–°å®¿å€ XX", "phone": "+81-3-1234-5678", "bookingId": "ABC123", "price": 12000, "notes": "å«æ—©é¤" }
            ]</code>
          </p>
        </div>
      </div>

      <section id="stayList"></section>
      <div class="spacer"></div>
    </section>
  </div>

  <!-- Modal: export -->
  <div class="modal-bg" id="modalBg">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="header">
        <h3 id="modalTitle">åŒ¯å‡º / è©³ç´°</h3>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="copyBtn">è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
          <button class="btn" id="closeModalBtn">é—œé–‰</button>
        </div>
      </div>
      <div id="modalBody">
        <textarea id="exportArea" readonly></textarea>
      </div>
    </div>
  </div>

<script>
/* =========================
   Tabs åˆ‡æ›
   ========================= */
const navTabs = document.querySelectorAll('.nav-tab');
const pages = document.querySelectorAll('.page');

navTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.dataset.page;
    navTabs.forEach(t => t.classList.toggle('active', t === tab));
    pages.forEach(p => p.classList.toggle('active', p.id === 'page-' + target));
  });
});

/* =========================
   è¡Œç¨‹ Data & Storage
   ========================= */
const STORAGE_KEY = "trip_timeline_schedule_v1";

function genId(){
  return "e_" + Math.random().toString(36).slice(2,9);
}

// sample three-day Tokyo itinerary
const SAMPLE = {
  meta: { title: "ä¸‰æ—¥æ±äº¬éŠ (ç¯„ä¾‹)", created: new Date().toISOString() },
  days: {
    1: [
      { id: genId(), time:"09:00", title:"æˆç”°æ©Ÿå ´ â†’ æ±äº¬å¸‚å€ (Skyliner)", detail:"æ­ Skyliner è‡³ä¸Šé‡/æ—¥æš®é‡Œï¼Œå†è½‰è»Šå‰å¾€é£¯åº—ã€‚", map:"https://maps.app.goo.gl/Q3bNQxC9NYF" },
      { id: genId(), time:"11:30", title:"æ·ºè‰å¯º & ä»²è¦‹ä¸–å•†åº—è¡—", detail:"æ‹ç…§ã€åƒäººå½¢ç‡’ã€é€›åœŸç”¢åº—ã€‚", map:"https://maps.app.goo.gl/P1Z3DvXHnBB" },
      { id: genId(), time:"14:30", title:"æ™´ç©ºå¡” (Skytree)", detail:"ç™»é«˜æœ›é ï¼‹è³¼ç‰©", map:"https://maps.app.goo.gl/RTyH1cZyQh9" }
    ],
    2: [
      { id: genId(), time:"10:00", title:"æ˜æ²»ç¥å®®", detail:"åƒæ‹œï¼‹æ£®æ—æ­¥é“", map:"https://maps.app.goo.gl/1C8YJwSgKqS" },
      { id: genId(), time:"12:00", title:"åŸå®¿ ç«¹ä¸‹é€š", detail:"é€›è¡—ã€å¯éº—é¤…", map:"https://maps.app.goo.gl/pcN3rBhxE7L" },
      { id: genId(), time:"15:00", title:"æ¶‰è°·åå­—è·¯å£", detail:"æ‹ç…§ã€æ˜Ÿå·´å…‹è§€æ™¯", map:"https://maps.app.goo.gl/Xz8Ff6QeaP7" }
    ],
    3: [
      { id: genId(), time:"09:30", title:"ç¯‰åœ°å ´å¤–å¸‚å ´", detail:"æµ·é®®æ—©é¤ã€ç”Ÿé­šç‰‡", map:"https://maps.app.goo.gl/cQCxRy8xr9C" },
      { id: genId(), time:"13:00", title:"éŠ€åº§è³¼ç‰©", detail:"UNIQLOã€ç™¾è²¨é€›è¡—", map:"https://maps.app.goo.gl/D7fMczF9aRq" },
      { id: genId(), time:"17:30", title:"å°å ´å¤œæ™¯ & è‡ªç”±å¥³ç¥åƒ", detail:"æµ·æ¿±æ•£æ­¥ã€å¤œæ™¯", map:"https://maps.app.goo.gl/2T8iTWZtJsV" }
    ]
  }
};

function saveToStorage(obj){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  } catch(e){ console.error("save fail", e); }
}
function loadFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  } catch(e){ console.error("load fail", e); return null; }
}

/* =========================
   Boot / UI init
   ========================= */
let schedule = loadFromStorage() || SAMPLE;
let currentDay = 1;

const timelineList = document.getElementById("timelineList");
const daysNav = document.getElementById("daysNav");
const dayButtons = daysNav.querySelectorAll(".day-btn");

function setActiveDay(day){
  currentDay = day;
  dayButtons.forEach(b=>b.classList.toggle("active", b.dataset.day==String(day)));
  renderTimeline();
}
dayButtons.forEach(b=>{
  b.addEventListener("click", ()=> setActiveDay(Number(b.dataset.day)));
});

// render hero date
document.getElementById("todayText").textContent =
  new Date().toLocaleDateString("zh-TW", {year:"numeric", month:"short", day:"numeric"});

// simple temp via open-meteo
fetch("https://api.open-meteo.com/v1/forecast?latitude=35.68&longitude=139.69&current_weather=true")
.then(r=>r.json()).then(d=>{
  if(d && d.current_weather) document.getElementById("tempText").textContent = d.current_weather.temperature + "Â°C";
}).catch(()=>{/* ignore */});

/* =========================
   Render timeline
   ========================= */
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"','&quot;'); }

function renderTimeline(){
  const list = schedule.days?.[currentDay] || [];
  timelineList.innerHTML = "";
  if(!list.length){
    timelineList.innerHTML = `<div style="color:var(--muted); padding:12px; background:var(--card); border-radius:14px;">å°šç„¡æ´»å‹•ï¼Œè«‹ç”¨ä¸Šæ–¹è¡¨å–®æ–°å¢æˆ–é»ã€Œæ–°å¢ç©ºç™½æ´»å‹•ã€</div>`;
    return initSortable(); // still init empty container
  }

  list.forEach((ev) => {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.id = ev.id;
    card.innerHTML = `
      <div class="icon" aria-hidden="true">ğŸ“</div>
      <div class="body">
        <div class="title">${escapeHtml(ev.title || "ï¼ˆæœªå¡«ï¼‰")}</div>
        <div class="meta">${escapeHtml(ev.time || "")} â€¢ ${escapeHtml(ev.detail || "")}</div>
        <div class="actions">
          ${ev.map ? `<a href="${ev.map}" target="_blank" class="link-btn">é–‹åœ°åœ–</a>` : ""}
          <button class="link-btn" data-action="edit">ç·¨è¼¯</button>
          <button class="link-btn" data-action="delete">åˆªé™¤</button>
        </div>
      </div>
    `;
    timelineList.appendChild(card);
  });

  initCardButtons();
  initSortable();
}

/* =========================
   Sortable (drag & drop)
   ========================= */
let sortableInstance = null;
function initSortable(){
  if(sortableInstance) {
    try{ sortableInstance.destroy(); }catch(e){}
    sortableInstance = null;
  }

  sortableInstance = new Sortable(timelineList, {
    animation: 160,
    ghostClass: 'ghost',
    fallbackOnBody: true,
    swapThreshold: 0.65,
    onEnd: function(){
      const ids = Array.from(timelineList.children).map(c => c.dataset.id);
      const dayArr = schedule.days[currentDay];
      const newArr = ids.map(id => dayArr.find(x=>x.id===id)).filter(Boolean);
      schedule.days[currentDay] = newArr;
      saveToStorage(schedule);
      renderTimeline();
    }
  });
}

/* =========================
   Card action buttons (edit/delete)
   ========================= */
function initCardButtons(){
  timelineList.querySelectorAll("[data-action]").forEach(btn=>{
    btn.onclick = function(){
      const action = this.dataset.action;
      const card = this.closest(".card");
      const id = card?.dataset.id;
      if(!id) return;
      if(action === "delete"){
        const arr = schedule.days[currentDay];
        schedule.days[currentDay] = arr.filter(x=>x.id !== id);
        saveToStorage(schedule);
        renderTimeline();
      } else if(action === "edit"){
        const ev = schedule.days[currentDay].find(x=>x.id===id);
        if(!ev) return;
        document.getElementById("daySelect").value = String(currentDay);
        document.getElementById("timeInput").value = ev.time || "";
        document.getElementById("titleInput").value = ev.title || "";
        document.getElementById("detailInput").value = ev.detail || "";
        document.getElementById("mapInput").value = ev.map || "";
        document.getElementById("addBtn").dataset.editId = id;
        scrollToTop();
      }
    };
  });
}

/* =========================
   Add / Quick add / Reset
   ========================= */
document.getElementById("addBtn").addEventListener("click", function(){
  const day = Number(document.getElementById("daySelect").value);
  const time = document.getElementById("timeInput").value.trim();
  const title = document.getElementById("titleInput").value.trim() || "ï¼ˆç„¡æ¨™é¡Œï¼‰";
  const detail = document.getElementById("detailInput").value.trim();
  const map = document.getElementById("mapInput").value.trim();

  const editId = this.dataset.editId;
  if(editId){
    const arr = schedule.days[day] || [];
    const idx = arr.findIndex(x=>x.id===editId);
    if(idx>=0){
      arr[idx] = { ...arr[idx], time, title, detail, map };
    }
    delete this.dataset.editId;
  } else {
    const ev = { id: genId(), time, title, detail, map };
    schedule.days[day] = schedule.days[day] || [];
    schedule.days[day].push(ev);
  }
  document.getElementById("timeInput").value = "";
  document.getElementById("titleInput").value = "";
  document.getElementById("detailInput").value = "";
  document.getElementById("mapInput").value = "";
  saveToStorage(schedule);
  setActiveDay(day);
});

document.getElementById("addQuickBtn").addEventListener("click", ()=>{
  const ev = { id: genId(), time:"09:00", title:"æ–°æ´»å‹•", detail:"å¯ç·¨è¼¯å…§å®¹", map:"" };
  schedule.days[currentDay] = schedule.days[currentDay] || [];
  schedule.days[currentDay].push(ev);
  saveToStorage(schedule);
  renderTimeline();
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(confirm("ç¢ºå®šè¦é‡ç½®ç‚ºä¸‰æ—¥ç¯„ä¾‹è³‡æ–™å—ï¼Ÿç›®å‰å…§å®¹æœƒè¢«è¦†è“‹ã€‚")) {
    schedule = JSON.parse(JSON.stringify(SAMPLE));
    saveToStorage(schedule);
    setActiveDay(1);
  }
});

/* =========================
   Export / Modal
   ========================= */
const modalBg = document.getElementById("modalBg");
const exportArea = document.getElementById("exportArea");
document.getElementById("openExport").addEventListener("click", ()=>{
  const payload = JSON.stringify(schedule, null, 2);
  exportArea.value = payload;
  document.getElementById("modalTitle").textContent = "åŒ¯å‡ºè¡Œç¨‹ JSONï¼ˆå¯è¤‡è£½ï¼‰";
  modalBg.style.display = "flex";
});
document.getElementById("copyBtn").addEventListener("click", ()=>{
  const text = exportArea.value;
  navigator.clipboard?.writeText(text).then(()=>{
    alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
  }).catch(()=>{ alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚"); });
});
document.getElementById("closeModalBtn").addEventListener("click", closeModal);
modalBg.addEventListener("click", (e)=>{ if(e.target===modalBg) closeModal(); });
function closeModal(){ modalBg.style.display = "none"; }

/* =========================
   Flights (local JSON only)
   ========================= */
const flightFileInput = document.getElementById('flightFileInput');
const flightList = document.getElementById('flightList');

if (flightFileInput){
  flightFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const flights = JSON.parse(e.target.result);
        renderFlights(flights);
      } catch (err) {
        alert('è®€å–æˆ–è§£æ JSON å¤±æ•—ï¼Œè«‹ç¢ºèªèˆªç­æª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
        console.error(err);
      }
    };
    reader.readAsText(file, 'utf-8');
  });
}

function renderFlights(flights){
  flightList.innerHTML = '';
  if (!Array.isArray(flights) || flights.length === 0){
    flightList.innerHTML = '<div class="card"><div class="body">ç›®å‰æ²’æœ‰èˆªç­è³‡æ–™ã€‚</div></div>';
    return;
  }
  flights.forEach(f => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="icon">âœˆï¸</div>
      <div class="body">
        <div class="card-title">
          ${escapeHtml(f.from || '')} â†’ ${escapeHtml(f.to || '')}
          ${f.date ? `<span class="chip">${escapeHtml(f.date)}</span>` : ''}
        </div>
        <div class="meta">
          èˆªç­ï¼š<strong>${escapeHtml(f.flightNumber || '-')}</strong>
          ${f.airline ? ` â€¢ èˆªç©ºå…¬å¸ï¼š${escapeHtml(f.airline)}` : ''}
        </div>
        <div class="meta">
          èµ·é£›ï¼š${escapeHtml(f.departTime || '-')}ã€€æŠµé”ï¼š${escapeHtml(f.arriveTime || '-')}
        </div>
        <div style="font-size:13px; color:var(--muted); margin-top:6px;">
          å‚™è¨»ï¼š${escapeHtml(f.notes || 'â€”')}
        </div>
      </div>
    `;
    flightList.appendChild(card);
  });
}

/* =========================
   Stays (local JSON only)
   ========================= */
const stayFileInput = document.getElementById('stayFileInput');
const stayList = document.getElementById('stayList');

if (stayFileInput){
  stayFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const stays = JSON.parse(e.target.result);
        renderStays(stays);
      } catch (err) {
        alert('è®€å–æˆ–è§£æ JSON å¤±æ•—ï¼Œè«‹ç¢ºèªä½å®¿æª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
        console.error(err);
      }
    };
    reader.readAsText(file, 'utf-8');
  });
}

function renderStays(stays){
  stayList.innerHTML = '';
  if (!Array.isArray(stays) || stays.length === 0){
    stayList.innerHTML = '<div class="card"><div class="body">ç›®å‰æ²’æœ‰ä½å®¿è³‡æ–™ã€‚</div></div>';
    return;
  }
  stays.forEach(s => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="icon">ğŸ¨</div>
      <div class="body">
        <div class="card-title">
          ${escapeHtml(s.name || 'æœªå‘½åä½å®¿')}
        </div>
        <div class="meta">
          <span class="chip">å…¥ä½ï¼š${escapeHtml(s.dateIn || '-')}</span>
          <span class="chip">é€€æˆ¿ï¼š${escapeHtml(s.dateOut || '-')}</span>
        </div>
        <div class="meta">åœ°å€ï¼š${escapeHtml(s.address || '-')}</div>
        <div class="meta">é›»è©±ï¼š${escapeHtml(s.phone || '-')}</div>
        <div class="meta">è¨‚å–®ç·¨è™Ÿï¼š<strong>${escapeHtml(s.bookingId || '-')}</strong></div>
        <div class="meta">
          åƒ¹æ ¼ï¼š${s.price != null ? escapeHtml(String(s.price)) + ' å…ƒ' : '-'}
        </div>
        <div style="font-size:13px; color:var(--muted); margin-top:6px;">
          å‚™è¨»ï¼š${escapeHtml(s.notes || 'â€”')}
        </div>
      </div>
    `;
    stayList.appendChild(card);
  });
}

/* =========================
   Utility
   ========================= */
function scrollToTop(){
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* initial load */
setActiveDay(1);
renderTimeline();
window.addEventListener("beforeunload", ()=> saveToStorage(schedule));
</script>
</body>
</html>
